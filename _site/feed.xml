<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Kevinlmll Blog</title>
    <description>è®°å½•å·¥ä½œã€å­¦ä¹ ä¸­é‡åˆ°çš„å„ç§çŸ¥è¯†</description>
    <link>http://localhost:4000/</link>
    <atom:link href="http://localhost:4000/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Sun, 17 May 2020 04:19:38 +0000</pubDate>
    <lastBuildDate>Sun, 17 May 2020 04:19:38 +0000</lastBuildDate>
    <generator>Jekyll v4.0.0</generator>
    
      <item>
        <title>MySQLä¸€æ¬¡æ•°æ®æ‹‰å–ä¹±ç çš„è¿‡ç¨‹åˆ†æ</title>
        <description>&lt;h4 id=&quot;èƒŒæ™¯&quot;&gt;èƒŒæ™¯&lt;/h4&gt;
&lt;p&gt;å‘¨äºŒï¼ˆ2019.11.19ï¼‰æ—¶ï¼Œä¸šåŠ¡ä¸Šåé¦ˆï¼Œä»xxçš„æ¥å£æ‹‰å–æ•°æ®ä¼šå°‘é‡å‡ºç°ä¹±ç ï¼Œè€Œä¸”æ˜ç¡®æ˜¯ä¸€ä¸ªemojiè¡¨æƒ…ï¼ˆğŸ ï¼‰æœ‰é—®é¢˜ã€‚&lt;/p&gt;

&lt;h4 id=&quot;è¿‡ç¨‹&quot;&gt;è¿‡ç¨‹&lt;/h4&gt;
&lt;p&gt;åº•å±‚æ•°æ®æ˜¯ç”¨DBå­˜å‚¨çš„ï¼Œæ‰˜ç®¡åœ¨å…¬å¸çš„MySQLé›†ç¾¤ä¸Šã€‚å› æ­¤ï¼Œç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æœ‰ä¸¤ä¸ªç‚¹ï¼š&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;æ•°æ®åº“è¡¨æ˜¯å¦ç”¨â€utf8mb4â€ä½œä¸ºå­—ç¬¦é›†ï¼›&lt;/li&gt;
  &lt;li&gt;è¿æ¥dbé‡Œï¼Œcharsetæ˜¯å¦æŒ‡å®šä¸ºâ€utf8â€ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ­¤æ—¶ï¼Œå¦ä¸€ä¸ªåŒäº‹è´´äº†å»ºè¡¨çš„DDLè¯­å¥ï¼š&lt;/p&gt;
&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;`xxxxx`&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
   &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;engine&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;innodb&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;charset&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8mb4&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;comment&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'xxx'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;/img/in-post/20200516_01_01.png&quot; alt=&quot;&quot; /&gt;
æ˜ç¡®äº†æ•°æ®åº“è¡¨æ˜¯ç”¨â€utf8mb4â€å­—ç¬¦é›†ã€‚
åŒæ—¶ï¼Œè´Ÿè´£æ¥å£çš„åŒäº‹ä¹ŸæŠŠè¿æ¥dbæ—¶çš„å‚æ•°è´´äº†å‡ºæ¥ï¼Œç¡®è®¤äº†è¿æ¥æ—¶ä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯â€utf8â€ã€‚&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;?charset=utf8&amp;amp;parseTime=true&amp;amp;loc=Local
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è€ƒè™‘åˆ°ä»¥ä½çš„ç»éªŒï¼Œ&lt;strong&gt;å½“æ•°æ®åº“è¡¨ç”¨â€utf8mb4â€ä½œä¸ºå­—ç¬¦é›†æ—¶ï¼Œè¿æ¥çš„charsetä¸èƒ½ç”¨â€utf8â€ï¼Œè¦ç”¨â€utf8mb4â€æˆ–è€…ç³»ç»Ÿé»˜è®¤ï¼ˆlatin1ï¼‰&lt;/strong&gt;ã€‚æ‰€ä»¥å½“æ—¶ç»™äº†è¿™ä¸ªå¤„ç†å»ºè®®ï¼š&lt;strong&gt;è°ƒæ•´è¿æ¥æ—¶ä½¿ç”¨çš„charsetï¼Œæ”¹ä¸ºâ€utf8mb4â€&lt;/strong&gt;ã€‚ç„¶è€ŒåŒäº‹åœ¨è°ƒæ•´äº†å¯¹åº”çš„å‚æ•°åï¼Œè¿˜æ˜¯æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ–°å†™å…¥æ•°æ®åœ¨è¯»å‡ºæ—¶è¿˜æ˜¯ä¹±ç ï¼Œå› æ­¤å¼€å¯äº†ä¸€æ®µå…³äºMySQLå­—ç¬¦é›†çš„æ¢ç´¢ä¹‹æ—…ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å‰§é€&lt;/strong&gt;ï¼šå…¶å®ä¸Šé¢æåˆ°çš„ï¼Œå°†è¿æ¥æ—¶ç”¨çš„charsetæ”¹ä¸ºâ€utf8mb4â€æ˜¯æ²¡é—®é¢˜ï¼ŒçœŸæ­£æ²¡æœ‰ç”Ÿæ•ˆçš„åŸå› æ˜¯åŒäº‹ä½¿ç”¨äº†DBè¿æ¥ç¼“å­˜æ± ï¼Œè°ƒæ•´charsetæ˜¯é€šè¿‡é…ç½®ä¸‹å‘çš„æ–¹å¼ï¼Œåªæœ‰æ–°å»ºç«‹çš„è¿æ¥æ‰èƒ½ç”Ÿæ•ˆï¼Œæ—§çš„è¿æ¥ä¸ä¼šé©¬ä¸Šè°ƒæ•´ï¼Œå› æ­¤æ•´ä½“æœåŠ¡è¿˜æ˜¯ç”¨â€utf8â€è¯»å†™æ•°æ®ã€‚åæ¥å¯¹æ¥å£è¿›ç¨‹è¿›è¡Œé‡å¯åï¼Œæ–°æ•°æ®è¯»å†™å°±ä¸å†æœ‰ä¹±ç äº†ã€‚&lt;/p&gt;

&lt;h4 id=&quot;è¸©å‘&quot;&gt;è¸©å‘&lt;/h4&gt;
&lt;p&gt;åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ˜¯è¸©äº†ä¸¤ä¸ªå‘çš„&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;æ•°æ®åº“è¡¨æ˜¯utf8mb4ï¼Œè¿æ¥ç”¨çš„æ˜¯utf8ï¼Œä¸ºä»€ä¹ˆå†™å…¥çš„æ•°æ®æ˜¯ä¹±ç ï¼›&lt;/li&gt;
  &lt;li&gt;ä¸­é—´åˆ†ææ•°æ®æ—¶ï¼Œæˆ‘ä»¬åˆ†åˆ«ç”¨python/golangæ‹‰å–æ•°æ®åº“é‡Œçš„åŸå§‹æ•°æ®ï¼Œå…¶ä¸­pythonèƒ½æ­£å¸¸æ˜¾ç¤ºâ€™ğŸ â€™ï¼Œè€Œgolangå´æŠ¥é”™ï¼›&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å½“æ—¶å†™å…¥æ•°æ®åº“çš„åŸå§‹æ•°æ®â€™ğŸ â€™ï¼Œ16è¿›åˆ¶æ˜¯&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;\xed\xa0\xbd\xed\xb0\xa0ï¼Œæ­£å¸¸çš„ç¼–ç åº”è¯¥æ˜¯\xf0\x9f\x90\xa0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ç”¨pythonæ˜¯å¯ä»¥æ­£å¸¸è¾“å‡º
&lt;img src=&quot;/img/in-post/20200516_01_02.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;mysqlå­—ç¬¦é›†æ¢ç´¢&quot;&gt;MySQLå­—ç¬¦é›†æ¢ç´¢&lt;/h4&gt;
&lt;p&gt;MySQLå¯¹utf8çš„æ”¯æŒæœ‰ä¸¤ç±»å­—ç¬¦é›†:utf8å’Œutf8mb4ï¼Œä¸¤è€…çš„å·®å¼‚åœ¨äºutf8çš„maxlenæ˜¯&lt;strong&gt;3&lt;/strong&gt;ï¼Œè€Œutf8mb4çš„maxlenæ˜¯&lt;strong&gt;4&lt;/strong&gt;ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ï¼Œä¾‹å¦‚emojiè¡¨æƒ…ï¼Œéœ€è¦ç”¨utf8mb4å­—ç¬¦é›†æ‰èƒ½å­˜å‚¨ã€‚ä¸ºäº†é¿å…æ··ä¹±ï¼Œä¸‹é¢ç”¨&lt;strong&gt;utf8mb3&lt;/strong&gt;ä»£æ›¿utf8ã€‚&lt;/p&gt;

&lt;p&gt;MySQLä¸­å­—ç¬¦é›†çš„è½¬æ¢å—åˆ°3ä¸ªç³»ç»Ÿå˜é‡æ§åˆ¶[1]ï¼Œå¦‚ä¸‹ï¼š
|~ ç³»ç»Ÿå˜é‡ |~ æè¿° |
| â€” | â€” |
| character_set_client | æœåŠ¡å™¨è§£ç è¯·æ±‚æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† |
| character_set_connection | æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶ä¼šæŠŠè¯·æ±‚å­—ç¬¦ä¸²ä»&lt;em&gt;character_set_client&lt;/em&gt; è½¬ä¸º &lt;em&gt;character_set_connection&lt;/em&gt; |
| character_set_results | æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æ•°æ®æ—¶ä½¿ç”¨çš„å­—ç¬¦é›† |&lt;/p&gt;

&lt;p&gt;å¦å¤–è¦è¡¥å……çš„ç‚¹æ˜¯ï¼Œé€šè¿‡&lt;em&gt;set names encoding&lt;/em&gt;çš„æ–¹å¼ï¼Œæ˜¯å°†ä»¥ä¸Š3è€…éƒ½ç»Ÿä¸€è¿›è¡Œè®¾ç½®ã€‚&lt;/p&gt;
&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;names&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ç»Ÿä¸€å°†&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;character_set_&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;connection&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;result&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;}è®¾ç½®ä¸º&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™å‡ ä¸ªç³»ç»Ÿå˜é‡åœ¨å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯æ—¶çš„ä½œç”¨ä½“ç°å¦‚ä¸‹[1]ï¼š
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p149&quot; alt=&quot;52a74fdd4fff1a883aa92fea6be6ab51.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;åˆ©ç”¨ä¸Šå›¾è¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹å‰æ–‡æåˆ°çš„ä¹±ç æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ã€‚&lt;/p&gt;

&lt;p&gt;| åŸæ•°æ® | utf8(mb3) hex | utf8mb4 hex |
| â€” | â€” | â€” |
| ğŸ  | \xed\xa0\xbd\xed\xb0\xa0 | \xf0\x9f\x90\xa0 |&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;æ“ä½œç³»ç»Ÿé»˜è®¤çš„å­—ç¬¦é›†ä¸€èˆ¬æ˜¯utf8ï¼ˆæ³¨æ„ï¼Œè¿™ä¸ªæ˜¯é€šç”¨çš„utf8ï¼Œä¸æ˜¯MySQLé‡Œé¢çš„utf8ï¼‰ï¼Œè¿™æ—¶ä¼ è¾“çš„æ•°æ®æ˜¯â€&lt;strong&gt;\xf0\x9f\x90\xa0&lt;/strong&gt;â€œï¼›&lt;/li&gt;
  &lt;li&gt;åˆå§‹åŒ–è¿æ¥DBæ—¶æŒ‡å®šcharsetä¸ºutf8(utf8mb3ï¼Œå®é™…)ï¼Œç”±äºcharset_clientå’Œcharset_connectionä¸€è‡´ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥å¯ä»¥ä¸è½¬æ¢ï¼›&lt;/li&gt;
  &lt;li&gt;æ•°æ®åº“è¡¨åˆ›å»ºæ—¶æŒ‡å®šçš„charsetæ˜¯utf8mb4ï¼Œè€Œcharset_connectionæ˜¯utf8mb3ï¼Œä¸¤è€…æœ‰å·®å¼‚ï¼Œæ‰€ä»¥MySQLä¼šå¯¹â€&lt;strong&gt;\xf0\x9f\x90\xa0&lt;/strong&gt;â€œåšä¸€æ¬¡è½¬æ¢ï¼Œå˜æˆâ€&lt;strong&gt;\xed\xa0\xbd\xed\xb0\xa0&lt;/strong&gt;â€œå†™å…¥æ•°æ®åº“è¡¨ï¼›&lt;/li&gt;
  &lt;li&gt;è¯»å–æ—¶ï¼Œç”±äºutf8mb4æ˜¯utf8(mb3)çš„è¶…é›†ï¼Œå› æ­¤ï¼ŒMySQLä¸ä¼šè¿›è¡Œè½¬æ¢ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°çš„æ•°æ®æ˜¯â€&lt;strong&gt;\xed\xa0\xbd\xed\xb0\xa0&lt;/strong&gt;â€œï¼›&lt;/li&gt;
  &lt;li&gt;å®¢æˆ·ç«¯æ— æ³•è¯†åˆ«â€&lt;strong&gt;\xed\xa0\xbd\xed\xb0\xa0&lt;/strong&gt;â€œï¼Œä¸æ˜¯æœ‰æ•ˆçš„utf8ç¼–ç ï¼Œå±•ç¤ºå˜æˆä¹±ç ï¼ˆå¦‚æœç”¨pythonçš„è¯ï¼Œå¯ä»¥æ˜¾ç¤ºæ­£å¸¸ï¼‰ï¼›&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;é‚£ä¹ˆï¼Œå½“æˆ‘ä»¬æŠŠè¿æ¥æ—¶çš„charsetè®¾ç½®ä¸ºutf8mb4æ—¶ï¼Œä¹Ÿå°±è§£å†³äº†å‰é¢ç¬¬3æ­¥é‡Œè½¬æ¢çš„bugï¼ŒMySQLåˆ¤æ–­charset_connectionä¸åˆ—çš„charsetä¸€è‡´ï¼Œä¸ä¼šåšè½¬æ¢ï¼Œæ•°æ®æ­£ç¡®ã€‚ï¼ˆé—®é¢˜ï¼šè®¾ç½®ä¸ºlatin1ä¸ºä»€ä¹ˆä¹Ÿå¯ä»¥ï¼Ÿï¼‰&lt;/p&gt;

&lt;h4 id=&quot;pythongolangå¯¹utf8çš„ç¼–è§£ç å¤„ç†&quot;&gt;python,golangå¯¹utf8çš„ç¼–è§£ç å¤„ç†&lt;/h4&gt;
&lt;p&gt;å‰é¢æœ‰æåˆ°ï¼Œç”¨pythonè¯»å–æ•°æ®åº“é‡Œæœ‰é—®é¢˜çš„utf8æ•°æ®æ—¶ï¼Œæ˜¯æ­£å¸¸å±•ç¤ºçš„ï¼Œè€Œä¸”golangç­‰å…¶å®ƒæ–¹å¼åˆ™ä¼šæŠ¥é”™ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œå»ç¿»äº†python 2.7ç‰ˆæœ¬å’Œgolangçš„æºä»£ç ï¼Œå¦‚ä¸‹ï¼š
pythonç‰ˆï¼Œpythonæ”¾æ¾äº†3å­—èŠ‚utf8çš„é™åˆ¶ï¼Œå…¼å®¹ï¼ˆ\xed\xa0\x80-\xed\xbf\xbf) è¿™æ®µåŒºé—´çš„å€¼ã€‚
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p150&quot; alt=&quot;eb0f90827bb66f251aada6629eb02e17.png&quot; /&gt;
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p151&quot; alt=&quot;61b972d33980c6ade95e66ca56f84e7a.png&quot; /&gt;
golangç‰ˆï¼Œgolangè¦æ±‚3å­—èŠ‚çš„utf8,æœ€ä½ä½çš„å­—èŠ‚æ˜¯åœ¨0x80ï½0xBF ä¹‹é—´
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p152&quot; alt=&quot;1151095366c16c5584e9e6a76b7e12ba.png&quot; /&gt;
å› æ­¤ï¼Œå¯¹äºã€ŒğŸ ã€è¢«è½¬æˆ3å­—èŠ‚çš„utf8 â€œ&lt;em&gt;\xed\xa0\xbd\xed\xb0\xa0&lt;/em&gt;â€œï¼Œpythonèƒ½å¤Ÿå®Œå…¨å…¼å®¹ï¼ˆä»£ç é‡Œæ³¨é‡Šæ˜¯å¯ä»¥uncomment ifæ¡ä»¶é‡Œçš„æ³¨é‡Šï¼Œä½¿ä¹‹éæ³•ï¼‰ï¼Œä½†æ˜¯golangç­‰å…¶å®ƒåˆ™ä¼šæŠ¥é”™ã€‚&lt;/p&gt;

&lt;h4 id=&quot;æ„æ–™ä¹‹å¤–&quot;&gt;æ„æ–™ä¹‹å¤–&lt;/h4&gt;
&lt;p&gt;ä¸Šé¢çš„é—®é¢˜å‘ç°åœ¨å…¬å¸çš„é›†ç¾¤DBä¸Šï¼Œåœ¨è‡ªå·±æœºå™¨çš„MySQLæœåŠ¡ä¸Šè¯•äº†ä¸‹ï¼Œç»“æœå‡ºä¹æ„æ–™ä¹‹å¤–ï¼Œåªåœ¨è®¾ç½®utf8mb4æ•°æ®æ‰èƒ½æ­£å¸¸å†™å…¥ã€‚å…¬å¸é›†ç¾¤MySQLä¸è‡ªå·±æœºå™¨ä¸Šçš„MySQLå·®å¼‚ï¼Œè¿™ä¸ªå°±æ— ä»è¿½æŸ¥äº†ï¼ˆT_Tï¼‰ã€‚
è‡ªå·±æœºå™¨ä¸Šçš„MySQL
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p153&quot; alt=&quot;afb91665307526930f22f063417a2996.png&quot; /&gt;
å…¬å¸é›†ç¾¤MySQL
&lt;img src=&quot;evernotecid://EC17A7A5-D681-44A9-9B09-540A7DDA8F83/appyinxiangcom/10822562/ENResource/p154&quot; alt=&quot;30a250e6fa09a3b54ddaa4388ee80d5e.png&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;å¼•ç”¨&quot;&gt;å¼•ç”¨&lt;/h4&gt;
&lt;p&gt;[1] https://juejin.im/book/5bffcbc9f265da614b11b731 MySQL æ˜¯æ€æ ·è¿è¡Œçš„ï¼šä»æ ¹å„¿ä¸Šç†è§£ MySQLâ€“ç¬¬4èŠ‚&lt;/p&gt;

</description>
        <pubDate>Sat, 16 May 2020 12:00:00 +0000</pubDate>
        <link>http://localhost:4000/2020/05/16/mysql-error-codec-analyze/</link>
        <guid isPermaLink="true">http://localhost:4000/2020/05/16/mysql-error-codec-analyze/</guid>
        
        <category>mysql</category>
        
        
      </item>
    
      <item>
        <title>Golangé‡Œmapå’ŒSync.Mapçš„ä¸åŒ</title>
        <description>&lt;h3 id=&quot;golangé‡Œmapå’Œsyncmapçš„ä¸åŒ&quot;&gt;Golangé‡Œmapå’ŒSync.Mapçš„ä¸åŒ&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨Golangçš„åŒå­¦éƒ½çŸ¥é“ï¼Œgolangæä¾›äº†mapå’Œsync.Mapä¸¤ç§å­—å…¸æ•°æ®ç»“æ„ã€‚ç®€å•çš„ä»åŒ…åå¯ä»¥çœ‹å‡ºï¼Œsync.Mapä½œä¸ºsyncåŒ…é‡Œçš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œç›¸å¯¹äºå†…ç½®çš„mapæ•°æ®ç»“æ„ï¼Œåº”è¯¥æ˜¯æ”¯æŒåŒæ­¥è¯­ä¹‰ï¼Œç®€åŒ–å¼€å‘åšåŒæ­¥åŒ–çš„ç¼–ç è¿‡ç¨‹ã€‚ä½†æ˜¯map+lock/mutexçš„æ–¹å¼ä¹Ÿå¯ä»¥ä¿è¯mapé‡Œæ“ä½œæ•°æ®åŒæ­¥åŒ–ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸¤è€…çš„å·®å¼‚åœ¨å“ªé‡Œå‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹sync.MapåŒ…çš„æ–‡æ¡£è¯´æ˜:&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;Map is like a Go map[interface{}]interface{} but is safe for concurrent use by multiple goroutines without additional locking or coordination. Loads, stores, and deletes run in amortized constant time.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;sync.Mapæ˜¯ä¸€ç§ç±»å‹Go map[interface{}]interface{}çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å®ƒåœ¨å¤šåç¨‹å¹¶å‘ä½¿ç”¨ä¸Šæ›´åŠ å®‰å…¨ï¼Œå¹¶ä¸”ä¸éœ€è¦é¢å¤–çš„é”å’Œæ¡ä»¶å˜é‡ã€‚å®ƒåœ¨è¯»ã€å†™ã€åˆ é™¤çš„æ“ä½œå¹³å‡è€—æ—¶æ˜¯å¸¸é‡æ—¶é—´ã€‚&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Map type is specialized. Most code should use a plain Go map instead, with separate locking or coordination, for better type safety and to make it easier to maintain other invariants along with the map content.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;sync.Mapè¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ç‰¹åˆ¶çš„ã€‚ä¸ºäº†æ›´å¥½çš„ç±»å‹å®‰å…¨ï¼Œmapé‡Œä¸å˜é‡çš„æ›´æ˜“ç»´æŠ¤æ€§ï¼Œå»ºè®®æ˜¯ä½¿ç”¨åŸå§‹çš„Go mapåŠ ç‹¬ç«‹é”/æ¡ä»¶å˜é‡çš„æ–¹å¼æ¥å¼€å‘&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, or (2) when multiple goroutines read, write, and overwrite entries for disjoint sets of keys. In these two cases, use of a Map may significantly reduce lock contention compared to a Go map paired with a separate Mutex or RWMutex.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;sync.Mapæ•°æ®ç»“æ„ä¸“é—¨ä¸ºä»¥ä¸‹ä¸¤ç§åœºæ™¯ä¸‹è¿›è¡Œä¼˜åŒ–ï¼šï¼ˆ1ï¼‰å¯¹äºä¸€äº›Key,å…³è”çš„å†…å®¹å®ä½“æ˜¯åªå†™ä¸€æ¬¡ï¼Œä½†æœ‰å¤§é‡çš„è¯»ï¼Œç±»ä¼¼ï¼Œä½¿ç”¨ç¼“å­˜æ—¶åªæœ‰Keyå¢é•¿ï¼Œæˆ–è€…ï¼ˆ2ï¼‰å¤šä¸ªå¹¶å‘åè®®è¯»ã€å†™ã€ä¿®æ”¹çš„Keysé›†åˆæ˜¯ä¸ç›¸äº¤çš„ã€‚åŸºäºä»¥ä¸Šçš„ä¸¤ä¸ªåœºæ™¯ï¼Œå¯¹æ¯”Go map+ç‹¬ç«‹Mutex/RWMutexæ–¹æ¡ˆï¼Œä½¿ç”¨sync.Mapå¯ä»¥æå¤§çš„å‡å°‘äº‰å¤ºé”çš„æ¶ˆè€—&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The zero Map is empty and ready for use. A Map must not be copied after first use.`&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;åˆå§‹åŒ–åçš„sync.Mapæ˜¯ç©ºçš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å½“sync.Mapè¢«ä½¿ç”¨åï¼Œ&lt;strong&gt;ä¸€å®š&lt;/strong&gt;ä¸èƒ½è¿›è¡Œå¤åˆ¶&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;ä»æ–‡æ¡£çš„æè¿°çœ‹åˆ°ï¼Œsync.Mapä¸»è¦æ˜¯é’ˆå¯¹ä¸¤ç±»åœºæ™¯åšäº†ä¼˜åŒ–ï¼šå†™å°‘è¯»å¤šï¼ˆå†™åªæ˜¯åœ¨åˆå§‹åŒ–åˆ›å»ºï¼‰ï¼Œä»¥åŠå¤šä¸ªåç¨‹å˜æ›´çš„Keyé›†ä¸ç›¸äº¤ã€‚é‚£ä¹ˆå…·ä½“å®ç°çš„ç»†èŠ‚æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;sync.Mapæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼Œç®€å•ä»‹ç»ä¸€ä¸‹Mapç»“æ„é‡Œå‡ ä¸ªå­—æ®µçš„ä½œç”¨ã€‚muä¸dirtyé…åˆä½¿ç”¨ï¼Œå½“éœ€è¦å†™dirtyé‡Œçš„æ•°æ®æ—¶ï¼Œé€šè¿‡muæ¥è·å–é”ï¼›readï¼Œä¸»è¦æ˜¯å†å²æ•°æ®ï¼Œè¯»çš„æ—¶å€™ä½¿ç”¨ï¼Œå¯ä»¥ä¸åŠ é”ï¼Œæ›´æ–°å†å²keyçš„æ•°æ®æ—¶ï¼Œéœ€è¦ç”¨åˆ°muæ¥å¾—åˆ°é”ï¼›missesï¼Œè®°å½•åœ¨readæœªè·å¾—keyæ•°æ®çš„æ¬¡æ•°ï¼Œå½“è¯¥æ¬¡æ•°è¶…è¿‡dirtyçš„å¤§å°æ—¶ï¼Œä¼šå°†dirtyçš„æ•°æ®åŒæ­¥åˆ°readï¼ŒåŒæ—¶æ¸…ç©ºdirty[å«ä¹‰å°±æ˜¯ï¼šæœªå‘½ä¸­cacheï¼Œå¯¼è‡´éœ€è¦é‡è¯»çš„æ¶ˆè€—å·²ç»å¤§äºæŠŠdirtyå¤åˆ¶åˆ°readçš„æ¶ˆè€—]ã€‚
&lt;img src=&quot;/img/in-post/sync-map-struct.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å…ˆçœ‹å†™è¿‡ç¨‹ï¼Œsync.Map.Storeæ¥å£è´Ÿè´£æ•°æ®æ›´æ–°ï¼Œå’Œsync.Map.Deleteæ¥å£è´Ÿè´£åˆ é™¤ã€‚
Storeå‡½æ•°ä»£ç åˆ†æ&lt;/p&gt;
&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tryStore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unexpungeLocked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// The entry was previously expunged, which implies that there is a&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// non-nil dirty map and this entry is not in it.&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;storeLocked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;storeLocked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// We're adding the first new key to the dirty map.&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// Make sure it is allocated and mark the read-only map as incomplete.&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirtyLocked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newEntry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
  &lt;li&gt;åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œåˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼Œå¦‚æœåœ¨readé‡Œï¼Œå°è¯•å†™å…¥ï¼ŒæˆåŠŸåˆ™ç»“æŸï¼ˆæˆåŠŸæ¡ä»¶ï¼škeyå¯¹åº”çš„valueä¸æ˜¯å·²åˆ é™¤ï¼Œæ›´æ–°æ—¶ï¼Œé€šè¿‡å¤šæ¬¡compare and swapä¿è¯åŸå­æ€§ï¼‰ï¼Œå¦åˆ™è½¬2ï¼›&lt;/li&gt;
  &lt;li&gt;å¦‚æœkeyä¸åœ¨readé‡Œæˆ–è€…keyå¯¹åº”çš„valueå·²åˆ é™¤ï¼Œé€šè¿‡muè·å–é”ï¼Œé‡æ–°åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œé‡æ–°åˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼ˆæœ‰å¯èƒ½åœ¨ç­‰å¾…é”è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶å®ƒæ•°æ®æ›´æ–°ï¼‰ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ¤æ–­valueæ˜¯å¦å·²åˆ é™¤è¿‡ï¼Œè‹¥valueå·²åˆ é™¤è¿‡ï¼Œåˆ™åœ¨&lt;em&gt;dirty&lt;/em&gt;å¢åŠ key-valueå…³ç³»å¯¹ï¼›æ›´æ–°valueæ–°çš„å€¼ï¼›è‹¥keyä¸åœ¨readé‡Œï¼Œè½¬3ï¼›&lt;/li&gt;
  &lt;li&gt;åˆ¤æ–­keyæ˜¯å¦åœ¨dirtyé‡Œï¼Œå¦‚æœå­˜åœ¨ï¼Œæ›´æ–°valueæ–°çš„å€¼ï¼›å¦åˆ™è½¬4ï¼›&lt;/li&gt;
  &lt;li&gt;å¦‚æœ&lt;em&gt;read&lt;/em&gt;æœªä¿®æ”¹è¿‡ï¼Œåˆ›å»ºdirtyï¼ˆåˆ†é…å†…å­˜ï¼Œcopyæ•°æ®ï¼Œ&lt;strong&gt;valueä¸ºnilçš„keyæ˜¯å¤„äºè¢«åˆ é™¤çŠ¶æ€ï¼Œä¸ä¼šè¢«copy&lt;/strong&gt;ï¼‰ï¼Œå¹¶æ›´æ–°readçš„çŠ¶æ€ä¸ºâ€œè¢«ä¿®æ”¹è¿‡â€ï¼Œåœ¨&lt;em&gt;dirty&lt;/em&gt;å¢åŠ key-valueå…³ç³»å¯¹ï¼›&lt;/li&gt;
  &lt;li&gt;é‡Šæ”¾mué”ï¼›&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Deleteå‡½æ•°ä»£ç åˆ†æ&lt;/p&gt;
&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;nb&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
  &lt;li&gt;åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œå¦‚æœkeyå·²å­˜åœ¨ï¼Œç›´æ¥åˆ é™¤ï¼Œç»“æŸï¼›å¦åˆ™è½¬2ï¼›&lt;/li&gt;
  &lt;li&gt;å¦‚æœkeyä¸å­˜åœ¨ï¼Œå¹¶ä¸”readè¢«ä¿®æ”¹è¿‡ï¼Œé€šè¿‡muè·å–é”ï¼Œå†é‡æ–°åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œå†é‡æ–°åˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼ˆæœ‰å¯èƒ½åœ¨æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹è¿‡ï¼‰ï¼Œå¦‚æœkeyè¿˜æ˜¯ä¸å­˜åœ¨å¹¶ä¸”readè¿˜æ˜¯å¤„äºâ€œè¢«ä¿®æ”¹è¿‡â€çš„çŠ¶æ€ï¼Œä»&lt;em&gt;dirty&lt;/em&gt;é‡Œåˆ é™¤keyï¼›é‡Šæ”¾é”ï¼›&lt;/li&gt;
  &lt;li&gt;å¦‚æœåœ¨æ˜¯2é‡ŒæŸ¥åˆ°keyæ˜¯å­˜åœ¨çš„ï¼Œåˆ™ç›´æ¥åˆ é™¤ï¼Œç»“æŸï¼›&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;å†çœ‹è¯»è¿‡ç¨‹ï¼Œsync.Map.Loadæ¥å£è´Ÿè´£è¯»å–æ•°æ®ï¼Œsync.Map.Rangeæ¥å£è´Ÿè´£éå†æ•°æ®é›†
Loadå‡½æ•°ä»£ç åˆ†æ&lt;/p&gt;
&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{},&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Avoid reporting a spurious miss if m.dirty got promoted while we were&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// blocked on m.mu. (If further loads of the same key will not miss, it's&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// not worth copying the dirty map for this key.)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// Regardless of whether the entry was present, record a miss: this key&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// will take the slow path until the dirty map is promoted to the read&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// map.&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;missLocked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
  &lt;li&gt;åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨readé‡Œï¼Œå¦‚æœä¸å­˜åœ¨å¹¶ä¸”readå¤„äºâ€œè¢«ä¿®æ”¹â€çŠ¶æ€ï¼Œç”³è¯·mué”ï¼›é‡æ–°åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œå¦‚æœreadè¿˜æ˜¯æ²¡æœ‰keyå¹¶ä¸”å¤„ç†â€œè¢«ä¿®æ”¹â€
çŠ¶æ€ï¼Œä»&lt;em&gt;dirty&lt;/em&gt;é‡Œè·å–ï¼Œé‡Šæ”¾é”ï¼›é€šè¿‡&lt;em&gt;missLocked&lt;/em&gt;è¿›è¡Œä¸€æ¬¡è¯»å–ç»Ÿè®¡ï¼›é‡Šæ”¾é”ï¼›&lt;/li&gt;
  &lt;li&gt;å¦‚æœreadé‡Œæ²¡æœ‰Key, å¹¶ä¸”readæ²¡æœ‰â€è¢«ä¿®æ”¹â€çš„çŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å›(nil, false)&lt;/li&gt;
  &lt;li&gt;keyå­˜åœ¨ï¼Œè¿”å›å¯¹åº”çš„value(æ­¤æ—¶ï¼Œä¹Ÿæœ‰å¯èƒ½valueä¸ºnil)ï¼›&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Rangeå‡½æ•°ä»£ç åˆ†æ&lt;/p&gt;
&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Range&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// We need to be able to iterate over all of the keys that were already&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// present at the start of the call to Range.&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// If read.amended is false, then read.m satisfies that property without&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// requiring us to hold m.mu for a long time.&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// m.dirty contains keys not in read.m. Fortunately, Range is already O(N)&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// (assuming the caller does not break out early), so a call to Range&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// amortizes an entire copy of the map: we can promote the dirty copy&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// immediately!&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amended&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dirty&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;misses&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mu&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;continue&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ol&gt;
  &lt;li&gt;åŠ è½½&lt;em&gt;read&lt;/em&gt;ï¼Œå¦‚æœreadå¤„äºâ€è¢«ä¿®æ”¹â€çŠ¶æ€ï¼Œè¿™é‡Œï¼Œç›´æ¥åšä¸€æ¬¡ä»dirtyåˆ°readçš„æ›¿æ¢ï¼Œæ›´æ–°readï¼Œå¹¶å°†dirtyç½®ä¸ºnil, missæ¬¡æ•°é‡ç½®ä¸º0ï¼›é‡Šæ”¾é”ï¼›&lt;/li&gt;
  &lt;li&gt;ä»&lt;em&gt;read&lt;/em&gt;é‡Œå¾ªç¯éå†key-value;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ€»ç»“ï¼š&lt;em&gt;read&lt;/em&gt;å¯ä»¥å½“ä½œä¸€ä¸ªé™æ€æ•°æ®é›†ï¼Œæ”¯æŒä¸åŠ é”ï¼Œå¿«é€Ÿçš„è¯»å–ï¼›&lt;em&gt;dirty&lt;/em&gt;åŒ…æ‹¬&lt;em&gt;read&lt;/em&gt;é‡Œénilçš„æ•°æ®é›†å’Œæ–°å¢çš„æ•°æ®é›†ï¼›å½“è®¿é—®&lt;em&gt;dirty&lt;/em&gt;é‡Œçš„keyæ¬¡æ•°å¤§äº&lt;em&gt;dirty&lt;/em&gt;å¤§å°æ—¶ï¼Œä¼šå°†&lt;em&gt;dirty&lt;/em&gt;é‡Œçš„æ•°æ®copyåˆ°&lt;em&gt;read&lt;/em&gt;ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—ï¼ˆå› ä¸ºèƒ½åœ¨&lt;em&gt;read&lt;/em&gt;è®¿é—®åˆ°keyæ—¶ï¼Œæ˜¯å¯ä»¥ä¸åŠ é”æ“ä½œã€‚è€Œè®¿é—®&lt;em&gt;dirty&lt;/em&gt;æˆ–è€…keyä¸åœ¨readæ—¶[readè¢«ä¿®æ”¹è¿‡]ï¼Œéœ€è¦åŠ é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰ã€‚å†å›å¤´çœ‹çœ‹sync.Mapçš„é€‚ç”¨åœºæ™¯ï¼š&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;ï¼ˆ1ï¼‰å¯¹äºä¸€äº›Key,å…³è”çš„å†…å®¹å®ä½“æ˜¯åªå†™ä¸€æ¬¡ï¼Œä½†æœ‰å¤§é‡çš„è¯»ï¼Œç±»ä¼¼ï¼Œä½¿ç”¨ç¼“å­˜æ—¶åªæœ‰Keyå¢é•¿&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å¤§é‡çš„è¯»å¯ä»¥åœ¨readé‡Œè·å–åˆ°ï¼ŒåŸºæœ¬å¯ä»¥ä¸åŠ é”ï¼Œå¯¹æ¯”ä½¿ç”¨å•ç‹¬çš„mutex/rwmutexè¦é«˜æ•ˆå¾—å¤šã€‚å°‘é‡çš„å†™å¹¶ä¸å½±å“ï¼Œåªæœ‰åœ¨è®¿é—®æ¬¡æ•°è¾¾åˆ°ä¸€å®šé‡åï¼Œæ‰ä¼šåšä¸€æ¬¡è¿ç§»ï¼›&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;ï¼ˆ2ï¼‰å¤šä¸ªå¹¶å‘åè®®è¯»ã€å†™ã€ä¿®æ”¹çš„Keysé›†åˆæ˜¯ä¸ç›¸äº¤çš„&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;åŒæ ·çš„åŸå› ï¼Œç”±äºkeysä¸ç›¸äº¤ï¼Œå¤§éƒ¨åˆ†çš„æ“ä½œå¯ä»¥åœ¨readå®ç°ä¸åŠ é”å¤„ç†ï¼Œæ¯”ä½¿ç”¨å•ç‹¬çš„å…¨å±€é”è¦é«˜æ•ˆã€‚æ–°å¢æˆ–è€…keyåœ¨dirtyæ—¶ï¼Œæ— æ³•é¿å…å…¨å±€é”ã€‚&lt;/p&gt;

&lt;p&gt;P.S. å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæ²¡æœ‰åœ¨ç½‘ä¸Šgoogleç›¸å…³çš„èµ„æ–™ï¼Œç„¶åä¸Šä¼ åˆ°å…¬ä¼—å·æ—¶ï¼Œä¸ºäº†æ‰¾ä¸ªå°é¢å›¾ï¼Œå‘ç°æœ‰äººå‘è¿‡å¾ˆè¯¦ç»†çš„è§£è¯»ï¼Œå›¾æ–‡å¹¶èŒ‚ï¼Œè¿™é‡Œé™„ä¸Šé“¾æ¥ï¼š&lt;a href=&quot;http://www.sreguide.com/go/sync_map.html&quot;&gt;sync_map&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Tue, 05 May 2020 12:00:00 +0000</pubDate>
        <link>http://localhost:4000/2020/05/05/golang-source-code-analyze-of-syncmap/</link>
        <guid isPermaLink="true">http://localhost:4000/2020/05/05/golang-source-code-analyze-of-syncmap/</guid>
        
        <category>golang</category>
        
        
      </item>
    
  </channel>
</rss>
