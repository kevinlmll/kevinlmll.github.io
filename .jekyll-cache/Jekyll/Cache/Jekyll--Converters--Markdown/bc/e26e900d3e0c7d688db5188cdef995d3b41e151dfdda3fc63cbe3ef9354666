I"ı\<h3 id="golangé‡Œmapå’Œsyncmapçš„ä¸åŒ">Golangé‡Œmapå’ŒSync.Mapçš„ä¸åŒ</h3>

<p>ä½¿ç”¨Golangçš„åŒå­¦éƒ½çŸ¥é“ï¼Œgolangæä¾›äº†mapå’Œsync.Mapä¸¤ç§å­—å…¸æ•°æ®ç»“æ„ã€‚ç®€å•çš„ä»åŒ…åå¯ä»¥çœ‹å‡ºï¼Œsync.Mapä½œä¸ºsyncåŒ…é‡Œçš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œç›¸å¯¹äºå†…ç½®çš„mapæ•°æ®ç»“æ„ï¼Œåº”è¯¥æ˜¯æ”¯æŒåŒæ­¥è¯­ä¹‰ï¼Œç®€åŒ–å¼€å‘åšåŒæ­¥åŒ–çš„ç¼–ç è¿‡ç¨‹ã€‚ä½†æ˜¯map+lock/mutexçš„æ–¹å¼ä¹Ÿå¯ä»¥ä¿è¯mapé‡Œæ“ä½œæ•°æ®åŒæ­¥åŒ–ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸¤è€…çš„å·®å¼‚åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹sync.MapåŒ…çš„æ–‡æ¡£è¯´æ˜:</p>
<blockquote>
  <p>Map is like a Go map[interface{}]interface{} but is safe for concurrent use by multiple goroutines without additional locking or coordination. Loads, stores, and deletes run in amortized constant time.</p>
</blockquote>

<p><em>sync.Mapæ˜¯ä¸€ç§ç±»å‹Go map[interface{}]interface{}çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å®ƒåœ¨å¤šåç¨‹å¹¶å‘ä½¿ç”¨ä¸Šæ›´åŠ å®‰å…¨ï¼Œå¹¶ä¸”ä¸éœ€è¦é¢å¤–çš„é”å’Œæ¡ä»¶å˜é‡ã€‚å®ƒåœ¨è¯»ã€å†™ã€åˆ é™¤çš„æ“ä½œå¹³å‡è€—æ—¶æ˜¯å¸¸é‡æ—¶é—´ã€‚</em></p>

<blockquote>
  <p>The Map type is specialized. Most code should use a plain Go map instead, with separate locking or coordination, for better type safety and to make it easier to maintain other invariants along with the map content.</p>
</blockquote>

<p><em>sync.Mapè¿™ä¸ªæ•°æ®ç»“æ„æ˜¯ç‰¹åˆ¶çš„ã€‚ä¸ºäº†æ›´å¥½çš„ç±»å‹å®‰å…¨ï¼Œmapé‡Œä¸å˜é‡çš„æ›´æ˜“ç»´æŠ¤æ€§ï¼Œå»ºè®®æ˜¯ä½¿ç”¨åŸå§‹çš„Go mapåŠ ç‹¬ç«‹é”/æ¡ä»¶å˜é‡çš„æ–¹å¼æ¥å¼€å‘</em></p>

<blockquote>
  <p>The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, or (2) when multiple goroutines read, write, and overwrite entries for disjoint sets of keys. In these two cases, use of a Map may significantly reduce lock contention compared to a Go map paired with a separate Mutex or RWMutex.</p>
</blockquote>

<p><em>sync.Mapæ•°æ®ç»“æ„ä¸“é—¨ä¸ºä»¥ä¸‹ä¸¤ç§åœºæ™¯ä¸‹è¿›è¡Œä¼˜åŒ–ï¼šï¼ˆ1ï¼‰å¯¹äºä¸€äº›Key,å…³è”çš„å†…å®¹å®ä½“æ˜¯åªå†™ä¸€æ¬¡ï¼Œä½†æœ‰å¤§é‡çš„è¯»ï¼Œç±»ä¼¼ï¼Œä½¿ç”¨ç¼“å­˜æ—¶åªæœ‰Keyå¢é•¿ï¼Œæˆ–è€…ï¼ˆ2ï¼‰å¤šä¸ªå¹¶å‘åè®®è¯»ã€å†™ã€ä¿®æ”¹çš„Keysé›†åˆæ˜¯ä¸ç›¸äº¤çš„ã€‚åŸºäºä»¥ä¸Šçš„ä¸¤ä¸ªåœºæ™¯ï¼Œå¯¹æ¯”Go map+ç‹¬ç«‹Mutex/RWMutexæ–¹æ¡ˆï¼Œä½¿ç”¨sync.Mapå¯ä»¥æå¤§çš„å‡å°‘äº‰å¤ºé”çš„æ¶ˆè€—</em></p>

<blockquote>
  <p>The zero Map is empty and ready for use. A Map must not be copied after first use.`</p>
</blockquote>

<p><em>åˆå§‹åŒ–åçš„sync.Mapæ˜¯ç©ºçš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å½“sync.Mapè¢«ä½¿ç”¨åï¼Œ<strong>ä¸€å®š</strong>ä¸èƒ½è¿›è¡Œå¤åˆ¶</em></p>

<p>ä»æ–‡æ¡£çš„æè¿°çœ‹åˆ°ï¼Œsync.Mapä¸»è¦æ˜¯é’ˆå¯¹ä¸¤ç±»åœºæ™¯åšäº†ä¼˜åŒ–ï¼šå†™å°‘è¯»å¤šï¼ˆå†™åªæ˜¯åœ¨åˆå§‹åŒ–åˆ›å»ºï¼‰ï¼Œä»¥åŠå¤šä¸ªåç¨‹å˜æ›´çš„Keyé›†ä¸ç›¸äº¤ã€‚é‚£ä¹ˆå…·ä½“å®ç°çš„ç»†èŠ‚æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>

<p>sync.Mapæ¶‰åŠåˆ°çš„æ•°æ®ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼Œç®€å•ä»‹ç»ä¸€ä¸‹Mapç»“æ„é‡Œå‡ ä¸ªå­—æ®µçš„ä½œç”¨ã€‚muä¸dirtyé…åˆä½¿ç”¨ï¼Œå½“éœ€è¦å†™dirtyé‡Œçš„æ•°æ®æ—¶ï¼Œé€šè¿‡muæ¥è·å–é”ï¼›readï¼Œä¸»è¦æ˜¯å†å²æ•°æ®ï¼Œè¯»çš„æ—¶å€™ä½¿ç”¨ï¼Œå¯ä»¥ä¸åŠ é”ï¼Œæ›´æ–°å†å²keyçš„æ•°æ®æ—¶ï¼Œéœ€è¦ç”¨åˆ°muæ¥å¾—åˆ°é”ï¼›missesï¼Œè®°å½•åœ¨readæœªè·å¾—keyæ•°æ®çš„æ¬¡æ•°ï¼Œå½“è¯¥æ¬¡æ•°è¶…è¿‡dirtyçš„å¤§å°æ—¶ï¼Œä¼šå°†dirtyçš„æ•°æ®åŒæ­¥åˆ°readï¼ŒåŒæ—¶æ¸…ç©ºdirty[å«ä¹‰å°±æ˜¯ï¼šæœªå‘½ä¸­cacheï¼Œå¯¼è‡´éœ€è¦é‡è¯»çš„æ¶ˆè€—å·²ç»å¤§äºæŠŠdirtyå¤åˆ¶åˆ°readçš„æ¶ˆè€—]ã€‚
<img src="/img/in-post/sync-map-struct.png" alt="" /></p>

<p>å…ˆçœ‹å†™è¿‡ç¨‹ï¼Œsync.Map.Storeæ¥å£è´Ÿè´£æ•°æ®æ›´æ–°ï¼Œå’Œsync.Map.Deleteæ¥å£è´Ÿè´£åˆ é™¤ã€‚
Storeå‡½æ•°ä»£ç åˆ†æ</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Map</span><span class="p">)</span> <span class="n">Store</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">];</span> <span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="n">tryStore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">unexpungeLocked</span><span class="p">()</span> <span class="p">{</span>
			<span class="c">// The entry was previously expunged, which implies that there is a</span>
			<span class="c">// non-nil dirty map and this entry is not in it.</span>
			<span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">.</span><span class="n">storeLocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">[</span><span class="n">key</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">.</span><span class="n">storeLocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
			<span class="c">// We're adding the first new key to the dirty map.</span>
			<span class="c">// Make sure it is allocated and mark the read-only map as incomplete.</span>
			<span class="n">m</span><span class="o">.</span><span class="n">dirtyLocked</span><span class="p">()</span>
			<span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">readOnly</span><span class="p">{</span><span class="n">m</span><span class="o">:</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">amended</span><span class="o">:</span> <span class="no">true</span><span class="p">})</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">newEntry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<ol>
  <li>åŠ è½½<em>read</em>ï¼Œåˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼Œå¦‚æœåœ¨readé‡Œï¼Œå°è¯•å†™å…¥ï¼ŒæˆåŠŸåˆ™ç»“æŸï¼ˆæˆåŠŸæ¡ä»¶ï¼škeyå¯¹åº”çš„valueä¸æ˜¯å·²åˆ é™¤ï¼Œæ›´æ–°æ—¶ï¼Œé€šè¿‡å¤šæ¬¡compare and swapä¿è¯åŸå­æ€§ï¼‰ï¼Œå¦åˆ™è½¬2ï¼›</li>
  <li>å¦‚æœkeyä¸åœ¨readé‡Œæˆ–è€…keyå¯¹åº”çš„valueå·²åˆ é™¤ï¼Œé€šè¿‡muè·å–é”ï¼Œé‡æ–°åŠ è½½<em>read</em>ï¼Œé‡æ–°åˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼ˆæœ‰å¯èƒ½åœ¨ç­‰å¾…é”è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶å®ƒæ•°æ®æ›´æ–°ï¼‰ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ¤æ–­valueæ˜¯å¦å·²åˆ é™¤è¿‡ï¼Œè‹¥valueå·²åˆ é™¤è¿‡ï¼Œåˆ™åœ¨<em>dirty</em>å¢åŠ key-valueå…³ç³»å¯¹ï¼›æ›´æ–°valueæ–°çš„å€¼ï¼›è‹¥keyä¸åœ¨readé‡Œï¼Œè½¬3ï¼›</li>
  <li>åˆ¤æ–­keyæ˜¯å¦åœ¨dirtyé‡Œï¼Œå¦‚æœå­˜åœ¨ï¼Œæ›´æ–°valueæ–°çš„å€¼ï¼›å¦åˆ™è½¬4ï¼›</li>
  <li>å¦‚æœ<em>read</em>æœªä¿®æ”¹è¿‡ï¼Œåˆ›å»ºdirtyï¼ˆåˆ†é…å†…å­˜ï¼Œcopyæ•°æ®ï¼Œ<strong>valueä¸ºnilçš„keyæ˜¯å¤„äºè¢«åˆ é™¤çŠ¶æ€ï¼Œä¸ä¼šè¢«copy</strong>ï¼‰ï¼Œå¹¶æ›´æ–°readçš„çŠ¶æ€ä¸ºâ€œè¢«ä¿®æ”¹è¿‡â€ï¼Œåœ¨<em>dirty</em>å¢åŠ key-valueå…³ç³»å¯¹ï¼›</li>
  <li>é‡Šæ”¾mué”ï¼›</li>
</ol>

<p>Deleteå‡½æ•°ä»£ç åˆ†æ</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Map</span><span class="p">)</span> <span class="n">Delete</span><span class="p">(</span><span class="n">key</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
	<span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
		<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
		<span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
			<span class="nb">delete</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">.</span><span class="nb">delete</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<ol>
  <li>åŠ è½½<em>read</em>ï¼Œå¦‚æœkeyå·²å­˜åœ¨ï¼Œç›´æ¥åˆ é™¤ï¼Œç»“æŸï¼›å¦åˆ™è½¬2ï¼›</li>
  <li>å¦‚æœkeyä¸å­˜åœ¨ï¼Œå¹¶ä¸”readè¢«ä¿®æ”¹è¿‡ï¼Œé€šè¿‡muè·å–é”ï¼Œå†é‡æ–°åŠ è½½<em>read</em>ï¼Œå†é‡æ–°åˆ¤æ–­keyæ˜¯å¦åœ¨readé‡Œï¼ˆæœ‰å¯èƒ½åœ¨æœ€è¿‘ä¸€æ¬¡ä¿®æ”¹è¿‡ï¼‰ï¼Œå¦‚æœkeyè¿˜æ˜¯ä¸å­˜åœ¨å¹¶ä¸”readè¿˜æ˜¯å¤„äºâ€œè¢«ä¿®æ”¹è¿‡â€çš„çŠ¶æ€ï¼Œä»<em>dirty</em>é‡Œåˆ é™¤keyï¼›é‡Šæ”¾é”ï¼›</li>
  <li>å¦‚æœåœ¨æ˜¯2é‡ŒæŸ¥åˆ°keyæ˜¯å­˜åœ¨çš„ï¼Œåˆ™ç›´æ¥åˆ é™¤ï¼Œç»“æŸï¼›</li>
</ol>

<p>å†çœ‹è¯»è¿‡ç¨‹ï¼Œsync.Map.Loadæ¥å£è´Ÿè´£è¯»å–æ•°æ®ï¼Œsync.Map.Rangeæ¥å£è´Ÿè´£éå†æ•°æ®é›†
Loadå‡½æ•°ä»£ç åˆ†æ</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Map</span><span class="p">)</span> <span class="n">Load</span><span class="p">(</span><span class="n">key</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">(</span><span class="n">value</span> <span class="k">interface</span><span class="p">{},</span> <span class="n">ok</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
	<span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
		<span class="c">// Avoid reporting a spurious miss if m.dirty got promoted while we were</span>
		<span class="c">// blocked on m.mu. (If further loads of the same key will not miss, it's</span>
		<span class="c">// not worth copying the dirty map for this key.)</span>
		<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
		<span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
			<span class="n">e</span><span class="p">,</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
			<span class="c">// Regardless of whether the entry was present, record a miss: this key</span>
			<span class="c">// will take the slow path until the dirty map is promoted to the read</span>
			<span class="c">// map.</span>
			<span class="n">m</span><span class="o">.</span><span class="n">missLocked</span><span class="p">()</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
<ol>
  <li>åŠ è½½<em>read</em>ï¼Œåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨readé‡Œï¼Œå¦‚æœä¸å­˜åœ¨å¹¶ä¸”readå¤„äºâ€œè¢«ä¿®æ”¹â€çŠ¶æ€ï¼Œç”³è¯·mué”ï¼›é‡æ–°åŠ è½½<em>read</em>ï¼Œå¦‚æœreadè¿˜æ˜¯æ²¡æœ‰keyå¹¶ä¸”å¤„ç†â€œè¢«ä¿®æ”¹â€
çŠ¶æ€ï¼Œä»<em>dirty</em>é‡Œè·å–ï¼Œé‡Šæ”¾é”ï¼›é€šè¿‡<em>missLocked</em>è¿›è¡Œä¸€æ¬¡è¯»å–ç»Ÿè®¡ï¼›é‡Šæ”¾é”ï¼›</li>
  <li>å¦‚æœreadé‡Œæ²¡æœ‰Key, å¹¶ä¸”readæ²¡æœ‰â€è¢«ä¿®æ”¹â€çš„çŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å›(nil, false)</li>
  <li>keyå­˜åœ¨ï¼Œè¿”å›å¯¹åº”çš„value(æ­¤æ—¶ï¼Œä¹Ÿæœ‰å¯èƒ½valueä¸ºnil)ï¼›</li>
</ol>

<p>Rangeå‡½æ•°ä»£ç åˆ†æ</p>
<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Map</span><span class="p">)</span> <span class="n">Range</span><span class="p">(</span><span class="n">f</span> <span class="k">func</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// We need to be able to iterate over all of the keys that were already</span>
	<span class="c">// present at the start of the call to Range.</span>
	<span class="c">// If read.amended is false, then read.m satisfies that property without</span>
	<span class="c">// requiring us to hold m.mu for a long time.</span>
	<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
		<span class="c">// m.dirty contains keys not in read.m. Fortunately, Range is already O(N)</span>
		<span class="c">// (assuming the caller does not break out early), so a call to Range</span>
		<span class="c">// amortizes an entire copy of the map: we can promote the dirty copy</span>
		<span class="c">// immediately!</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
		<span class="n">read</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Load</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="n">readOnly</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">read</span><span class="o">.</span><span class="n">amended</span> <span class="p">{</span>
			<span class="n">read</span> <span class="o">=</span> <span class="n">readOnly</span><span class="p">{</span><span class="n">m</span><span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="n">dirty</span><span class="p">}</span>
			<span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
			<span class="n">m</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="no">nil</span>
			<span class="n">m</span><span class="o">.</span><span class="n">misses</span> <span class="o">=</span> <span class="m">0</span>
		<span class="p">}</span>
		<span class="n">m</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">read</span><span class="o">.</span><span class="n">m</span> <span class="p">{</span>
		<span class="n">v</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">e</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">f</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<ol>
  <li>åŠ è½½<em>read</em>ï¼Œå¦‚æœreadå¤„äºâ€è¢«ä¿®æ”¹â€çŠ¶æ€ï¼Œè¿™é‡Œï¼Œç›´æ¥åšä¸€æ¬¡ä»dirtyåˆ°readçš„æ›¿æ¢ï¼Œæ›´æ–°readï¼Œå¹¶å°†dirtyç½®ä¸ºnil, missæ¬¡æ•°é‡ç½®ä¸º0ï¼›é‡Šæ”¾é”ï¼›</li>
  <li>ä»<em>read</em>é‡Œå¾ªç¯éå†key-value;</li>
</ol>

<p>æ€»ç»“ï¼š<em>read</em>å¯ä»¥å½“ä½œä¸€ä¸ªé™æ€æ•°æ®é›†ï¼Œæ”¯æŒä¸åŠ é”ï¼Œå¿«é€Ÿçš„è¯»å–ï¼›<em>dirty</em>åŒ…æ‹¬<em>read</em>é‡Œénilçš„æ•°æ®é›†å’Œæ–°å¢çš„æ•°æ®é›†ï¼›å½“è®¿é—®<em>dirty</em>é‡Œçš„keyæ¬¡æ•°å¤§äº<em>dirty</em>å¤§å°æ—¶ï¼Œä¼šå°†<em>dirty</em>é‡Œçš„æ•°æ®copyåˆ°<em>read</em>ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—ï¼ˆå› ä¸ºèƒ½åœ¨<em>read</em>è®¿é—®åˆ°keyæ—¶ï¼Œæ˜¯å¯ä»¥ä¸åŠ é”æ“ä½œã€‚è€Œè®¿é—®<em>dirty</em>æˆ–è€…keyä¸åœ¨readæ—¶[readè¢«ä¿®æ”¹è¿‡]ï¼Œéœ€è¦åŠ é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰ã€‚å†å›å¤´çœ‹çœ‹sync.Mapçš„é€‚ç”¨åœºæ™¯ï¼š</p>
<blockquote>
  <p>ï¼ˆ1ï¼‰å¯¹äºä¸€äº›Key,å…³è”çš„å†…å®¹å®ä½“æ˜¯åªå†™ä¸€æ¬¡ï¼Œä½†æœ‰å¤§é‡çš„è¯»ï¼Œç±»ä¼¼ï¼Œä½¿ç”¨ç¼“å­˜æ—¶åªæœ‰Keyå¢é•¿</p>
</blockquote>

<p>å¤§é‡çš„è¯»å¯ä»¥åœ¨readé‡Œè·å–åˆ°ï¼ŒåŸºæœ¬å¯ä»¥ä¸åŠ é”ï¼Œå¯¹æ¯”ä½¿ç”¨å•ç‹¬çš„mutex/rwmutexè¦é«˜æ•ˆå¾—å¤šã€‚å°‘é‡çš„å†™å¹¶ä¸å½±å“ï¼Œåªæœ‰åœ¨è®¿é—®æ¬¡æ•°è¾¾åˆ°ä¸€å®šé‡åï¼Œæ‰ä¼šåšä¸€æ¬¡è¿ç§»ï¼›</p>
<blockquote>
  <p>ï¼ˆ2ï¼‰å¤šä¸ªå¹¶å‘åè®®è¯»ã€å†™ã€ä¿®æ”¹çš„Keysé›†åˆæ˜¯ä¸ç›¸äº¤çš„</p>
</blockquote>

<p>åŒæ ·çš„åŸå› ï¼Œç”±äºkeysä¸ç›¸äº¤ï¼Œå¤§éƒ¨åˆ†çš„æ“ä½œå¯ä»¥åœ¨readå®ç°ä¸åŠ é”å¤„ç†ï¼Œæ¯”ä½¿ç”¨å•ç‹¬çš„å…¨å±€é”è¦é«˜æ•ˆã€‚æ–°å¢æˆ–è€…keyåœ¨dirtyæ—¶ï¼Œæ— æ³•é¿å…å…¨å±€é”ã€‚</p>

<p>P.S. å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œæ²¡æœ‰åœ¨ç½‘ä¸Šgoogleç›¸å…³çš„èµ„æ–™ï¼Œç„¶åä¸Šä¼ åˆ°å…¬ä¼—å·æ—¶ï¼Œä¸ºäº†æ‰¾ä¸ªå°é¢å›¾ï¼Œå‘ç°æœ‰äººå‘è¿‡å¾ˆè¯¦ç»†çš„è§£è¯»ï¼Œå›¾æ–‡å¹¶èŒ‚ï¼Œè¿™é‡Œé™„ä¸Šé“¾æ¥ï¼š<a href="http://www.sreguide.com/go/sync_map.html">sync_map</a></p>
:ET